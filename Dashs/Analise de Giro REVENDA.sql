SELECT
AAA.CODPROD,
AAA.DESCRPROD,
AAA.QTD_MIN,
CASE WHEN AAA.ANALISE_COMPRA > 0 THEN AAA.ANALISE_COMPRA
ELSE 0 END AS ANALISE_GIRO

FROM
(SELECT
DAD.CODPROD,
DAD.DESCRPROD,
DAD.QTD_MIN,
DAD.QTD_MAX,
DAD.QTD_INV,
DAD.ESTQ,
DAD.ESTQ_VEND,
CASE 
WHEN DAD.QTD_MAX > 0 THEN DAD.QTD_MAX - DAD.ESTQ
WHEN DAD.ESTQ_VEND < 0 THEN (DAD.QTD_MIN * :P_PERIODO) - DAD.QTD_INV
ELSE (DAD.QTD_MIN * :P_PERIODO) - DAD.ESTQ_VEND - DAD.QTD_INV END AS ANALISE_COMPRA

FROM
(SELECT
TTT.CODPROD,
TTT.DESCRPROD,
NVL(TTT.QTD_MIN,0) AS QTD_MIN,
NVL(TTT.QTD_MAX,0) AS QTD_MAX,
NVL(TTT.QTD_INV,0) AS QTD_INV,
NVL(TTT.ESTQ,0) AS ESTQ,
NVL(TTT.ESTQ - (TTT.QTD_MIN * 3),0) AS ESTQ_VEND
FROM
    (SELECT
    PRO.CODPROD,
    PRO.DESCRPROD,
    CASE
    WHEN :P_EMP = '1' THEN MIN.SP_1
    WHEN :P_EMP = '3' THEN MIN.MG_2
    WHEN :P_EMP = '4' THEN MIN.PE_3
    ELSE 0 END AS QTD_MIN,p8
    CASE
    WHEN :P_EMP = '1' THEN MAX.MXSP_1
    WHEN :P_EMP = '3' THEN MAX.MXMG_2
    WHEN :P_EMP = '4' THEN MAX.MXPE_3
    ELSE 0 END AS QTD_MAX,
    INV.QTDNEG AS QTD_INV,
    CASE
    WHEN :P_EMP = '1' THEN EST.ESTQ_SP
    WHEN :P_EMP = '3' THEN EST.ESTQ_MG
    WHEN :P_EMP = '4' THEN EST.ESTQ_PE
    ELSE 0 END AS ESTQ

    FROM
    TGFPRO PRO
    LEFT JOIN    (SELECT
        PRO.CODPROD,
        PRO.AD_QTDMIN_MAT AS SP_1,
        PRO.AD_QTDMIN_MNG AS MG_2,
        PRO.AD_QTDMIN_PER AS PE_3
        FROM
        TGFPRO PRO
        WHERE
        PRO.USOPROD = 'R'
        AND PRO.AD_COD_EX IS NULL
        AND PRO.ATIVO = 'S') MIN ON PRO.CODPROD = MIN.CODPROD

    LEFT JOIN    (SELECT
        PRO.CODPROD,
        PRO.AD_QTD_MAX_SP AS MXSP_1,
        PRO.AD_QTD_MAX_MG AS MXMG_2,
        PRO.AD_QTD_MAX_PE AS MXPE_3
        FROM
        TGFPRO PRO
        WHERE
        PRO.USOPROD = 'R'
        AND PRO.AD_COD_EX IS NULL
        AND PRO.ATIVO = 'S') MAX ON PRO.CODPROD = MAX.CODPROD

    LEFT JOIN    (SELECT
        CAB.NUNOTA,
        ITE.CODPROD,
        ITE.QTDNEG
        FROM 
        TGFCAB CAB
        LEFT JOIN TGFITE ITE ON ITE.NUNOTA = CAB.NUNOTA
        WHERE
        CAB.CODTIPOPER = '2000'
        AND CAB.CODEMP = :P_EMP
        AND CAB.STATUSNOTA = 'L'
        AND CAB.PENDENTE = 'S') INV ON PRO.CODPROD = INV.CODPROD

    LEFT JOIN    (SELECT
        PRO.CODPROD,
        PRO.DESCRPROD,
        MG.ESTOQUE AS ESTQ_MG,
        SP.ESTOQUE AS ESTQ_SP,
        PE.ESTOQUE AS ESTQ_PE
        FROM
        TGFPRO PRO
        LEFT JOIN (SELECT
            EST.CODPROD,
            PRO.DESCRPROD AS DESCRICAO,
            SUM(EST.ESTOQUE) AS ESTOQUE
            FROM 
            TGFEST EST
            JOIN TGFPRO PRO ON EST.CODPROD = PRO.CODPROD
            JOIN TGFLOC LOC ON EST.CODLOCAL = LOC.CODLOCAL
            WHERE
            EST.ESTOQUE > '0' AND PRO.USOPROD IN ('R') AND EST.CODEMP = '3'
            AND EST.CODLOCAL NOT IN ('10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','040010000')
            GROUP BY
            EST.CODPROD,
            PRO.DESCRPROD) MG ON MG.CODPROD = PRO.CODPROD
        LEFT JOIN (SELECT
            EST.CODPROD,
            PRO.DESCRPROD AS DESCRICAO,
            SUM(EST.ESTOQUE) AS ESTOQUE
            FROM 
            TGFEST EST
            JOIN TGFPRO PRO ON EST.CODPROD = PRO.CODPROD
            JOIN TGFLOC LOC ON EST.CODLOCAL = LOC.CODLOCAL
            WHERE
            EST.ESTOQUE > '0' AND PRO.USOPROD IN ('R') AND EST.CODEMP IN ('1','2')
            AND EST.CODLOCAL NOT IN ('10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','040010000')
            GROUP BY
            EST.CODPROD,
            PRO.DESCRPROD) SP ON SP.CODPROD = PRO.CODPROD
        LEFT JOIN (SELECT
            EST.CODPROD,
            PRO.DESCRPROD AS DESCRICAO,
            SUM(EST.ESTOQUE) AS ESTOQUE
            FROM 
            TGFEST EST
            JOIN TGFPRO PRO ON EST.CODPROD = PRO.CODPROD
            JOIN TGFLOC LOC ON EST.CODLOCAL = LOC.CODLOCAL
            WHERE
            EST.ESTOQUE > '0' AND PRO.USOPROD IN ('R') AND EST.CODEMP IN ('4')
            AND EST.CODLOCAL NOT IN ('10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','040010000')
            GROUP BY
            EST.CODPROD,
            PRO.DESCRPROD) PE ON PE.CODPROD = PRO.CODPROD
        WHERE
        PRO.USOPROD = 'R'
        AND SP.ESTOQUE <> '0' OR MG.ESTOQUE <> '0' OR PE.ESTOQUE <> '0') EST ON PRO.CODPROD = EST.CODPROD

    WHERE 
    PRO.USOPROD = 'R'
    AND PRO.AD_COD_EX IS NULL) TTT) DAD) AAA

