SELECT
ITE.CODPROD AS CODIGO,
PRO.DESCRPROD AS DESCRICAO,
ITE.QTDNEG AS QUANTIDADE,
ITE.VLRTOT AS VALOR_TOT_ITEN,
CUS.CUSREP AS CUSTO,
CAB.NUNOTA AS CAB_NUNOTA,
CAB.DTNEG AS DATA,
CAB.CODPARC AS COD_CLIENTE,
PAR.RAZAOSOCIAL AS CLIENTE,
PAR.AD_UF AS UF,
CID.NOMECID AS CIDADE,
DECODE (CAB.STATUSNOTA,'A','N√ÉO TERMINADO','P','PRODUTO PENDENTE','L','CONCLUIDO') AS STATUS

FROM TGFCAB CAB
 JOIN TGFPAR PAR ON CAB.CODPARC = PAR.CODPARC
 JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
 JOIN TGFPRO PRO ON ITE.CODPROD = PRO.CODPROD
 JOIN TSICID CID ON PAR.CODCID = CID.CODCID
 JOIN TGFCUS CUS ON ITE.CODPROD = CUS.CODPROD
 
WHERE 
CAB.CODTIPOPER = '3100' AND
PAR.AD_UF = 'Minas Gerais'
AND (CUS.DTATUAL = (SELECT MAX(C.DTATUAL) FROM TGFCUS C WHERE CUS.CODPROD = C.CODPROD AND C.DTATUAL <= CAB.DTNEG) OR CUS.DTATUAL IS NULL)

