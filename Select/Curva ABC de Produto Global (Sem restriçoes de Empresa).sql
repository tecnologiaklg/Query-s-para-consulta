SELECT
FFF.CODPROD,
FFF.PRODUTO,
FFF.GRUPO,
FFF.VLR,
FFF.PORC,
FFF.QTD,
EST.ESTQ_PE,
FFF.QTD_PE,
EST.ESTQ_MG,
FFF.QTD_MG,
EST.ESTQ_SP,
FFF.QTD_SP,
CASE WHEN FFF.POR_ACU >= 20 THEN 'A'
WHEN FFF.POR_ACU >= 5 THEN 'B'
ELSE 'C' END AS ABC
FROM
(SELECT
PPP.QTD_PE,
PPP.QTD_MG,
PPP.QTD_SP,
PPP.GRUPO,
PPP.CODPROD,
PPP.PRODUTO,
PPP.VLR,
PPP.PORC,
SUM(PPP.PORC) OVER (ORDER BY PPP.PORC) AS POR_ACU,
PPP.QTD
FROM
(SELECT
UUU.QTD_PE,
UUU.QTD_MG,
UUU.QTD_SP,
UUU.GRUPO,
UUU.CODPROD,
UUU.PRODUTO,
UUU.VLR,
TTT.VLR_TOT,
(UUU.VLR * 100) / TTT.VLR_TOT AS PORC,
UUU.QTD
FROM
(SELECT
AAA.QTD_PE,
AAA.QTD_MG,
AAA.QTD_SP,
AAA.GRUPO,
AAA.CODPROD,
AAA.DESCRPROD AS PRODUTO,
SUM(AAA.VLRTOT) AS VLR,
SUM(AAA.QTDNEG) AS QTD
FROM (SELECT
    DISTINCT(CAB.NUNOTA) AS NOTA,
    PRO.CODPROD,
    PRO.CODGRUPOPROD AS GRUPO,
    PRO.AD_QTDMIN_PER AS QTD_PE,
    PRO.AD_QTDMIN_MNG AS QTD_MG,
    PRO.AD_QTDMIN_MAT AS QTD_SP,
    PRO.DESCRPROD,
    ITE.VLRTOT,
    ITE.QTDNEG
    FROM TGFPRO PRO
    LEFT JOIN TGFITE ITE ON ITE.CODPROD = PRO.CODPROD
    LEFT JOIN TGFCAB CAB ON CAB.NUNOTA = ITE.NUNOTA
    WHERE CAB.DTNEG BETWEEN :PERIODO.INI AND :PERIODO.FIN
    AND CAB.VLRNOTA <> 0
    AND PRO.USOPROD = 'R'
    AND CAB.CODTIPOPER IN ('3200','3205','3250','3262'))AAA
GROUP BY
AAA.CODPROD,
AAA.DESCRPROD,
AAA.QTD_PE,
AAA.QTD_MG,
AAA.QTD_SP,
AAA.GRUPO
ORDER BY VLR DESC) UUU,
(SELECT
SUM(BBB.VLR) AS VLR_TOT
FROM
(SELECT
AAA.CODPROD,
AAA.DESCRPROD AS PRODUTO,
SUM(AAA.VLRTOT) AS VLR,
SUM(AAA.QTDNEG) AS QTD
FROM (SELECT
    DISTINCT(CAB.NUNOTA) AS NOTA,
    PRO.CODPROD,
    PRO.DESCRPROD,
    ITE.VLRTOT,
    ITE.QTDNEG
    FROM TGFPRO PRO
    LEFT JOIN TGFITE ITE ON ITE.CODPROD = PRO.CODPROD
    LEFT JOIN TGFCAB CAB ON CAB.NUNOTA = ITE.NUNOTA
    WHERE CAB.DTNEG BETWEEN :PERIODO.INI AND :PERIODO.FIN
    AND CAB.VLRNOTA <> 0
    AND PRO.USOPROD = 'R'
    AND CAB.CODTIPOPER IN ('3200','3205','3250','3262'))AAA
GROUP BY
AAA.CODPROD,
AAA.DESCRPROD
ORDER BY VLR DESC) BBB) TTT) PPP) FFF 
LEFT JOIN (SELECT
    PRO.CODPROD,
    MG.ESTOQUE AS ESTQ_MG,
    SP.ESTOQUE AS ESTQ_SP,
    PE.ESTOQUE AS ESTQ_PE
    FROM TGFPRO PRO LEFT JOIN (SELECT
        EST.CODPROD,
        PRO.DESCRPROD AS DESCRICAO,
        SUM(EST.ESTOQUE) AS ESTOQUE
        FROM TGFEST EST
        JOIN TGFPRO PRO ON EST.CODPROD = PRO.CODPROD
        JOIN TGFLOC LOC ON EST.CODLOCAL = LOC.CODLOCAL
        WHERE EST.ESTOQUE > '0' AND PRO.USOPROD IN ('R') AND EST.CODEMP = '3'
        AND EST.CODLOCAL NOT IN ('30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000') GROUP BY EST.CODPROD, PRO.DESCRPROD) MG ON MG.CODPROD = PRO.CODPROD
    LEFT JOIN (SELECT EST.CODPROD,
        PRO.DESCRPROD AS DESCRICAO,
        SUM(EST.ESTOQUE) AS ESTOQUE
        FROM TGFEST EST JOIN TGFPRO PRO ON EST.CODPROD = PRO.CODPROD
        JOIN TGFLOC LOC ON EST.CODLOCAL = LOC.CODLOCAL
        WHERE EST.ESTOQUE > '0' AND PRO.USOPROD IN ('R') AND EST.CODEMP IN ('1','2')
        AND EST.CODLOCAL NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000') GROUP BY EST.CODPROD, PRO.DESCRPROD) SP ON SP.CODPROD = PRO.CODPROD
    LEFT JOIN (SELECT
        EST.CODPROD,
        PRO.DESCRPROD AS DESCRICAO,
        SUM(EST.ESTOQUE) AS ESTOQUE
        FROM TGFEST EST
        JOIN TGFPRO PRO ON EST.CODPROD = PRO.CODPROD
        JOIN TGFLOC LOC ON EST.CODLOCAL = LOC.CODLOCAL
        WHERE EST.ESTOQUE > '0' AND PRO.USOPROD IN ('R') AND EST.CODEMP IN ('4')    
        AND EST.CODLOCAL NOT IN ('40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        GROUP BY EST.CODPROD,
        PRO.DESCRPROD) PE ON PE.CODPROD = PRO.CODPROD
    WHERE PRO.USOPROD = 'R' AND SP.ESTOQUE <> '0' OR MG.ESTOQUE <> '0' OR PE.ESTOQUE <> '0') EST ON FFF.CODPROD = EST.CODPROD

