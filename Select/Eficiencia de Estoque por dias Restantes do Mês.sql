SELECT
AVG(BBB.EFICIENCIA) AS EFIC
FROM
(SELECT
AAA.CODPROD,
AAA.QTD_SP,
AAA.ESTQ,
(AAA.ESTQ * 100) / AAA.QTD_DIA AS EFICIENCIA
FROM
(SELECT
MSP.CODPROD,
(MSP.QTD_SP / DIA.DM)*(DIA.DM - DIA.DIA) AS QTD_DIA,
MSP.QTD_SP,
NVL(EST.ESTQ,'0') AS ESTQ
FROM
/*QTD ESTQ MIN SP*/
    (SELECT
    PRO.CODPROD,
    PRO.AD_QTDMIN_MAT AS QTD_SP
    FROM
    TGFPRO PRO
    WHERE
    PRO.AD_QTDMIN_MAT IS NOT NULL
    AND PRO.AD_QTDMIN_MAT <> 0) MSP
LEFT JOIN
/*ESTOQUE ATUAL*/
    (SELECT
    EST.CODPROD,
    SUM(EST.ESTOQUE) AS ESTQ
    FROM
    TGFEST EST 
    WHERE
    EST.CODLOCAL NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
    AND EST.CODEMP IN ('1','2')
    GROUP BY
    EST.CODPROD) EST ON EST.CODPROD = MSP.CODPROD,
/*QTD DIAS NO MÃŠS*/
    (SELECT
    TO_CHAR(CURRENT_DATE,'dd') AS DIA,
    COUNT(CAL.DATACALEN) AS DM
    FROM
    AD_CALENDARIO CAL
    WHERE
    TO_CHAR(CAL.DATACALEN,'mm/yyyy') = TO_CHAR(CURRENT_DATE,'mm/yyyy')) DIA) AAA) BBB