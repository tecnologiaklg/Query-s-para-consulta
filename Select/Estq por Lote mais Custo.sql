SELECT
EST.CONTROLE AS LOTE,
EST.CODEMP AS EMPRESA,
SUM(EST.ESTOQUE) AS QUANTIDADE,
SUM(CCT.TOTAL) AS TOTAL

FROM
TGFEST EST
LEFT JOIN TGFPRO PRO ON EST.CODPROD = PRO.CODPROD
LEFT JOIN (SELECT
EST.CODPROD,
EST.CONTROLE,
EST.CODEMP,
EST.ESTOQUE AS QUANTIDADE,
CCC.CUSREP,
CCC.CUSREP * EST.ESTOQUE AS TOTAL
FROM
TGFEST EST
LEFT JOIN TGFPRO PRO ON EST.CODPROD = PRO.CODPROD
LEFT JOIN (SELECT 
                    DDD.CONTROLE,
                    DDD.CODPROD,
                    CUS.CUSREP
                    FROM TGFCUS CUS,
                        (SELECT 
                        MAX (EEE.DTATUAL) AS DATA,
                        EEE.CONTROLE,
                        EEE.CODPROD
                        FROM TGFCUS EEE
                        GROUP BY
                        EEE.CONTROLE,
                        EEE.CODPROD
                        ) DDD
                    WHERE
                    DDD.CONTROLE = CUS.CONTROLE
                    AND DDD.CODPROD = CUS.CODPROD
                    AND DDD.DATA = CUS.DTATUAL
                    )CCC ON EST.CODPROD = CCC.CODPROD AND CCC.CONTROLE = EST.CONTROLE
WHERE
EST.CODLOCAL NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
AND PRO.USOPROD = 'R' AND PRO.AD_COD_EX IS NULL) CCT ON EST.CODPROD = CCT.CODPROD AND CCT.CONTROLE = EST.CONTROLE

WHERE
EST.CODLOCAL NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
AND PRO.USOPROD = 'R' AND PRO.AD_COD_EX IS NULL

GROUP BY
EST.CONTROLE,
EST.CODEMP