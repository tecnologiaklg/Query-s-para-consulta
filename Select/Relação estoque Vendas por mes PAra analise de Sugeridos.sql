SELECT
PRO.CODPROD,
MS0.MES_ANO AS MES_ANO_0,
MS0.QTD_VEN AS VENDAS_0,
MS0.ESTQ_INI AS ESTQ_INI_0,
MS1.MES_ANO AS MES_ANO_1,
MS1.QTD_VEN AS VENDAS_1,
MS1.ESTQ_INI AS ESTQ_INI_1,
MS2.MES_ANO AS MES_ANO_2,
MS2.QTD_VEN AS VENDAS_2,
MS2.ESTQ_INI AS ESTQ_INI_2


FROM
TGFPRO PRO
LEFT JOIN (SELECT
    PRO.CODPROD,
    TO_CHAR((TO_DATE(CURRENT_DATE)),'mm/yyyy') AS MES_ANO,  -- COLOCAR DATA DE SUBTRAÇÃO
    NVL(VEN.QTD,0) AS QTD_VEN,
    (NVL(EST.ESTQ,0) + NVL(SAI.QTD,0) + NVL(TRS.QTD,0) - NVL(ENT.QTD,0) - NVL(TRE.QTD,0)) AS ESTQ_INI
    FROM
    TGFPRO PRO 
    /*VENDAS NO MES*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        TO_CHAR(CAB.DTNEG,'mm/yyyy') AS DT,
        SUM(ITE.QTDNEG) AS QTD
        FROM
        TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        WHERE
        CAB.CODTIPOPER IN ('3200','3210')
        AND TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE)),'mm/yyyy') -- COLOCAR DATA DE SUBTRAÇÃO
        GROUP BY
        ITE.CODPROD,
        CAB.DTNEG) VEN ON VEN.CODPROD = PRO.CODPROD
    /*ESTQ ATUAL*/
    LEFT JOIN(SELECT
        EST.CODPROD,
        SUM(EST.ESTOQUE) AS ESTQ
        FROM
        TGFEST EST 
        LEFT JOIN TGFPRO PRO ON EST.CODPROD = PRO.CODPROD
        WHERE
        EST.CODLOCAL NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        AND PRO.USOPROD = 'R'
        GROUP BY
        EST.CODPROD) EST ON EST.CODPROD = PRO.CODPROD
    /*ENTRADAS ( - )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM
        TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        WHERE
        CAB.CODTIPOPER IN ('2210','2260','2262','2200','2209','2212','2106','2196','2100')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 30),'mm/yyyy'))
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        GROUP BY
        ITE.CODPROD) ENT ON ENT.CODPROD = PRO.CODPROD
    /*SAIDAS ( + )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM
        TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        WHERE
        CAB.CODTIPOPER IN ('3200','3210','3260','3005')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 30),'mm/yyyy'))
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        GROUP BY
        ITE.CODPROD) SAI ON SAI.CODPROD = PRO.CODPROD
     /*TRANSFERENCIAS ENTRADAS ( - )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        LEFT JOIN (SELECT
            ITE.CODPROD,
            ITE.NUNOTA,
            ITE.SEQUENCIA
            FROM
            TGFITE ITE
            WHERE
            ITE.CODLOCALORIG IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
            AND ITE.SEQUENCIA > 0 -- VERIFICANDO O LOCAL DE ORIGEM
            ) ORI ON ORI.NUNOTA = ITE.NUNOTA AND ORI.SEQUENCIA <> ITE.SEQUENCIA
        WHERE CAB.CODTIPOPER IN ('1400')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 30),'mm/yyyy'))
        AND ITE.SEQUENCIA < 0 -- VERIFICANDO O LOCAL DE DESTINO
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        AND ITE.CODPROD IN (ORI.CODPROD)
        GROUP BY ITE.CODPROD) TRE ON TRE.CODPROD = PRO.CODPROD
    /*TRANSFERENCIAS SAIDAS ( + )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        LEFT JOIN (SELECT
            ITE.CODPROD,
            ITE.NUNOTA,
            ITE.SEQUENCIA
            FROM
            TGFITE ITE
            WHERE
            ITE.CODLOCALORIG IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
            AND ITE.SEQUENCIA < 0 -- VERIFICANDO O LOCAL DE ORIGEM
            ) ORI ON ORI.NUNOTA = ITE.NUNOTA AND ORI.SEQUENCIA <> ITE.SEQUENCIA
        WHERE CAB.CODTIPOPER IN ('1400')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 30),'mm/yyyy'))
        AND ITE.SEQUENCIA > 0 -- VERIFICANDO O LOCAL DE DESTINO
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        AND ITE.CODPROD IN (ORI.CODPROD)
        GROUP BY ITE.CODPROD) TRS ON TRS.CODPROD = PRO.CODPROD
    WHERE PRO.USOPROD = 'R' AND PRO.ATIVO = 'S'
    ) MS0 ON MS0.CODPROD = PRO.CODPROD
LEFT JOIN (SELECT
    PRO.CODPROD,
    TO_CHAR((TO_DATE(CURRENT_DATE) - 30),'mm/yyyy') AS MES_ANO,  -- COLOCAR DATA DE SUBTRAÇÃO
    NVL(VEN.QTD,0) AS QTD_VEN,
    (NVL(EST.ESTQ,0) + NVL(SAI.QTD,0) + NVL(TRS.QTD,0) - NVL(ENT.QTD,0) - NVL(TRE.QTD,0)) AS ESTQ_INI
    FROM
    TGFPRO PRO 
    /*VENDAS NO MES*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        TO_CHAR(CAB.DTNEG,'mm/yyyy') AS DT,
        SUM(ITE.QTDNEG) AS QTD
        FROM
        TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        WHERE
        CAB.CODTIPOPER IN ('3200','3210')
        AND TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 30),'mm/yyyy') -- COLOCAR DATA DE SUBTRAÇÃO
        GROUP BY
        ITE.CODPROD,
        CAB.DTNEG) VEN ON VEN.CODPROD = PRO.CODPROD
    /*ESTQ ATUAL*/
    LEFT JOIN(SELECT
        EST.CODPROD,
        SUM(EST.ESTOQUE) AS ESTQ
        FROM
        TGFEST EST 
        LEFT JOIN TGFPRO PRO ON EST.CODPROD = PRO.CODPROD
        WHERE
        EST.CODLOCAL NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        AND PRO.USOPROD = 'R'
        GROUP BY
        EST.CODPROD) EST ON EST.CODPROD = PRO.CODPROD
    /*ENTRADAS ( - )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM
        TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        WHERE
        CAB.CODTIPOPER IN ('2210','2260','2262','2200','2209','2212','2106','2196','2100')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 60),'mm/yyyy'))
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        GROUP BY
        ITE.CODPROD) ENT ON ENT.CODPROD = PRO.CODPROD
    /*SAIDAS ( + )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM
        TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        WHERE
        CAB.CODTIPOPER IN ('3200','3210','3260','3005')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 60),'mm/yyyy'))
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        GROUP BY
        ITE.CODPROD) SAI ON SAI.CODPROD = PRO.CODPROD
     /*TRANSFERENCIAS ENTRADAS ( - )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        LEFT JOIN (SELECT
            ITE.CODPROD,
            ITE.NUNOTA,
            ITE.SEQUENCIA
            FROM
            TGFITE ITE
            WHERE
            ITE.CODLOCALORIG IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
            AND ITE.SEQUENCIA > 0 -- VERIFICANDO O LOCAL DE ORIGEM
            ) ORI ON ORI.NUNOTA = ITE.NUNOTA AND ORI.SEQUENCIA <> ITE.SEQUENCIA
        WHERE CAB.CODTIPOPER IN ('1400')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 60),'mm/yyyy'))
        AND ITE.SEQUENCIA < 0 -- VERIFICANDO O LOCAL DE DESTINO
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        AND ITE.CODPROD IN (ORI.CODPROD)
        GROUP BY ITE.CODPROD) TRE ON TRE.CODPROD = PRO.CODPROD
    /*TRANSFERENCIAS SAIDAS ( + )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        LEFT JOIN (SELECT
            ITE.CODPROD,
            ITE.NUNOTA,
            ITE.SEQUENCIA
            FROM
            TGFITE ITE
            WHERE
            ITE.CODLOCALORIG IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
            AND ITE.SEQUENCIA < 0 -- VERIFICANDO O LOCAL DE ORIGEM
            ) ORI ON ORI.NUNOTA = ITE.NUNOTA AND ORI.SEQUENCIA <> ITE.SEQUENCIA
        WHERE CAB.CODTIPOPER IN ('1400')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 60),'mm/yyyy'))
        AND ITE.SEQUENCIA > 0 -- VERIFICANDO O LOCAL DE DESTINO
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        AND ITE.CODPROD IN (ORI.CODPROD)
        GROUP BY ITE.CODPROD) TRS ON TRS.CODPROD = PRO.CODPROD
    WHERE PRO.USOPROD = 'R' AND PRO.ATIVO = 'S'
    ) MS1 ON MS1.CODPROD = PRO.CODPROD
LEFT JOIN (SELECT
    PRO.CODPROD,
    TO_CHAR((TO_DATE(CURRENT_DATE) - 60),'mm/yyyy') AS MES_ANO,  -- COLOCAR DATA DE SUBTRAÇÃO
    NVL(VEN.QTD,0) AS QTD_VEN,
    (NVL(EST.ESTQ,0) + NVL(SAI.QTD,0) + NVL(TRS.QTD,0) - NVL(ENT.QTD,0) - NVL(TRE.QTD,0)) AS ESTQ_INI
    FROM
    TGFPRO PRO 
    /*VENDAS NO MES*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        TO_CHAR(CAB.DTNEG,'mm/yyyy') AS DT,
        SUM(ITE.QTDNEG) AS QTD
        FROM
        TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        WHERE
        CAB.CODTIPOPER IN ('3200','3210')
        AND TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 60),'mm/yyyy') -- COLOCAR DATA DE SUBTRAÇÃO
        GROUP BY
        ITE.CODPROD,
        CAB.DTNEG) VEN ON VEN.CODPROD = PRO.CODPROD
    /*ESTQ ATUAL*/
    LEFT JOIN(SELECT
        EST.CODPROD,
        SUM(EST.ESTOQUE) AS ESTQ
        FROM
        TGFEST EST 
        LEFT JOIN TGFPRO PRO ON EST.CODPROD = PRO.CODPROD
        WHERE
        EST.CODLOCAL NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        AND PRO.USOPROD = 'R'
        GROUP BY
        EST.CODPROD) EST ON EST.CODPROD = PRO.CODPROD
    /*ENTRADAS ( - )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM
        TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        WHERE
        CAB.CODTIPOPER IN ('2210','2260','2262','2200','2209','2212','2106','2196','2100')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 90),'mm/yyyy'))
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        GROUP BY
        ITE.CODPROD) ENT ON ENT.CODPROD = PRO.CODPROD
    /*SAIDAS ( + )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM
        TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        WHERE
        CAB.CODTIPOPER IN ('3200','3210','3260','3005')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 90),'mm/yyyy'))
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        GROUP BY
        ITE.CODPROD) SAI ON SAI.CODPROD = PRO.CODPROD
     /*TRANSFERENCIAS ENTRADAS ( - )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        LEFT JOIN (SELECT
            ITE.CODPROD,
            ITE.NUNOTA,
            ITE.SEQUENCIA
            FROM
            TGFITE ITE
            WHERE
            ITE.CODLOCALORIG IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
            AND ITE.SEQUENCIA > 0 -- VERIFICANDO O LOCAL DE ORIGEM
            ) ORI ON ORI.NUNOTA = ITE.NUNOTA AND ORI.SEQUENCIA <> ITE.SEQUENCIA
        WHERE CAB.CODTIPOPER IN ('1400')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 90),'mm/yyyy'))
        AND ITE.SEQUENCIA < 0 -- VERIFICANDO O LOCAL DE DESTINO
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        AND ITE.CODPROD IN (ORI.CODPROD)
        GROUP BY ITE.CODPROD) TRE ON TRE.CODPROD = PRO.CODPROD
    /*TRANSFERENCIAS SAIDAS ( + )*/
    LEFT JOIN(SELECT
        ITE.CODPROD,
        SUM(ITE.QTDNEG) AS QTD
        FROM TGFCAB CAB
        LEFT JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
        LEFT JOIN (SELECT
            ITE.CODPROD,
            ITE.NUNOTA,
            ITE.SEQUENCIA
            FROM
            TGFITE ITE
            WHERE
            ITE.CODLOCALORIG IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
            AND ITE.SEQUENCIA < 0 -- VERIFICANDO O LOCAL DE ORIGEM
            ) ORI ON ORI.NUNOTA = ITE.NUNOTA AND ORI.SEQUENCIA <> ITE.SEQUENCIA
        WHERE CAB.CODTIPOPER IN ('1400')
        AND CAB.DTNEG >= (SELECT MAX(CAB.DTNEG) AS MAX FROM TGFCAB CAB WHERE TO_CHAR(CAB.DTNEG,'mm/yyyy') = TO_CHAR((TO_DATE(CURRENT_DATE) - 90),'mm/yyyy'))
        AND ITE.SEQUENCIA > 0 -- VERIFICANDO O LOCAL DE DESTINO
        AND ITE.CODLOCALORIG NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
        AND ITE.CODPROD IN (ORI.CODPROD)
        GROUP BY ITE.CODPROD) TRS ON TRS.CODPROD = PRO.CODPROD
    WHERE PRO.USOPROD = 'R' AND PRO.ATIVO = 'S'
    ) MS2 ON MS2.CODPROD = PRO.CODPROD







WHERE PRO.USOPROD = 'R' AND PRO.AD_COD_EX IS NULL AND PRO.ATIVO = 'S' 