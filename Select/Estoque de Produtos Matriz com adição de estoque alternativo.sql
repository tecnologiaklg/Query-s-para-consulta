SELECT
ZZZ.CODPROD,
ZZZ.DESCRPROD,
ZZZ.ESTOQUE,
ZZZ.EMP,
NVL(ZZZ.ABC,'N') AS ABC,
PPP.CUSREP,
CASE
WHEN ZZZ.EMP = 'SP' THEN TO_CHAR(PRO.AD_QTDMIN_MAT,'9999')
WHEN ZZZ.EMP = 'MG' THEN TO_CHAR(PRO.AD_QTDMIN_MNG,'9999')
WHEN ZZZ.EMP = 'PE' THEN TO_CHAR(PRO.AD_QTDMIN_PER,'9999')
ELSE PRO.AD_QTDMIN_MAT ||'\'|| PRO.AD_QTDMIN_MNG ||'\'|| PRO.AD_QTDMIN_PER END AS QTD_MIN
FROM

TGFPRO PRO
LEFT JOIN (SELECT
    PRO.CODPROD,
    PRO.DESCRPROD,
    NVL(DDD.ESTOQUE,0) AS ESTOQUE,
    PRO.AD_ABC_SP AS ABC,
    'SP' AS EMP
    FROM
    TGFPRO PRO 
    LEFT JOIN (SELECT
    BBB.CODPROD,
    BBB.NOME_MATRIZ AS NOME,
    SUM(BBB.ESTOQUE) AS ESTOQUE
    FROM
    (SELECT
    AAA.CODPROD,
    AAA.NOME_MATRIZ,
    AAA.CODPRODALT,
    EST.ESTOQUE
    FROM
    (SELECT
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_MATRIZ,
            PAL.CODPRODALT
            FROM
            TGFPRO PRO
            LEFT JOIN TGFPAL PAL ON PAL.CODPROD = PRO.CODPROD
            WHERE
            PRO.USOPROD = 'R'
            AND PRO.AD_COD_EX IS NULL
            AND PRO.AD_TIP_ALT = 'M'
            UNION ALL
            SELECT
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_MATRIZ,
            PRO.CODPROD
            FROM
            TGFPRO PRO
            WHERE
            PRO.USOPROD = 'R'
            AND PRO.AD_COD_EX IS NULL
            AND PRO.AD_TIP_ALT = 'M'
            ) AAA
        LEFT JOIN TGFEST EST ON EST.CODPROD = AAA.CODPRODALT
    WHERE
    AAA.CODPRODALT IS NOT NULL
    AND EST.CODLOCAL NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
    AND EST.ESTOQUE > 0
    AND EST.CODEMP IN ('1','2'))BBB
    GROUP BY
    BBB.CODPROD,
    BBB.NOME_MATRIZ) DDD ON DDD.CODPROD = PRO.CODPROD
    WHERE
    PRO.USOPROD = 'R'
    AND PRO.AD_COD_EX IS NULL
    AND PRO.AD_TIP_ALT = 'M'

    UNION

    SELECT
    PRO.CODPROD,
    PRO.DESCRPROD,
    NVL(DDD.ESTOQUE,0) AS ESTOQUE,
    PRO.AD_ABC_MG AS ABC,
    'MG' AS EMP
    FROM
    TGFPRO PRO 
    LEFT JOIN (SELECT
    BBB.CODPROD,
    BBB.NOME_MATRIZ AS NOME,
    SUM(BBB.ESTOQUE) AS ESTOQUE
    FROM
    (SELECT
    AAA.CODPROD,
    AAA.NOME_MATRIZ,
    AAA.CODPRODALT,
    EST.ESTOQUE
    FROM
    (SELECT
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_MATRIZ,
            PAL.CODPRODALT
            FROM
            TGFPRO PRO
            LEFT JOIN TGFPAL PAL ON PAL.CODPROD = PRO.CODPROD
            WHERE
            PRO.USOPROD = 'R'
            AND PRO.AD_COD_EX IS NULL
            AND PRO.AD_TIP_ALT = 'M'
            UNION ALL
            SELECT
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_MATRIZ,
            PRO.CODPROD
            FROM
            TGFPRO PRO
            WHERE
            PRO.USOPROD = 'R'
            AND PRO.AD_COD_EX IS NULL
            AND PRO.AD_TIP_ALT = 'M'
            ) AAA
        LEFT JOIN TGFEST EST ON EST.CODPROD = AAA.CODPRODALT
    WHERE
    AAA.CODPRODALT IS NOT NULL
    AND EST.CODLOCAL NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
    AND EST.ESTOQUE > 0
    AND EST.CODEMP IN ('3'))BBB
    GROUP BY
    BBB.CODPROD,
    BBB.NOME_MATRIZ) DDD ON DDD.CODPROD = PRO.CODPROD
    WHERE
    PRO.USOPROD = 'R'
    AND PRO.AD_COD_EX IS NULL
    AND PRO.AD_TIP_ALT = 'M'

    UNION

    SELECT
    PRO.CODPROD,
    PRO.DESCRPROD,
    NVL(DDD.ESTOQUE,0) AS ESTOQUE,
    PRO.AD_ABC_PE AS ABC,
    'PE' AS EMP
    FROM
    TGFPRO PRO 
    LEFT JOIN (SELECT
    BBB.CODPROD,
    BBB.NOME_MATRIZ AS NOME,
    SUM(BBB.ESTOQUE) AS ESTOQUE
    FROM
    (SELECT
    AAA.CODPROD,
    AAA.NOME_MATRIZ,
    AAA.CODPRODALT,
    EST.ESTOQUE
    FROM
    (SELECT
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_MATRIZ,
            PAL.CODPRODALT
            FROM
            TGFPRO PRO
            LEFT JOIN TGFPAL PAL ON PAL.CODPROD = PRO.CODPROD
            WHERE
            PRO.USOPROD = 'R'
            AND PRO.AD_COD_EX IS NULL
            AND PRO.AD_TIP_ALT = 'M'
            UNION ALL
            SELECT
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_MATRIZ,
            PRO.CODPROD
            FROM
            TGFPRO PRO
            WHERE
            PRO.USOPROD = 'R'
            AND PRO.AD_COD_EX IS NULL
            AND PRO.AD_TIP_ALT = 'M'
            ) AAA
        LEFT JOIN TGFEST EST ON EST.CODPROD = AAA.CODPRODALT
    WHERE
    AAA.CODPRODALT IS NOT NULL
    AND EST.CODLOCAL NOT IN ('20010000', '20020000', '20030000', '20260000', '20280000','1010000', '10020000', '10370000', '10380000', '10390000', '10400000', '10410000', '10420000', '10430000', '10440000', '10450000', '10460000', '10470000', '10480000', '10490000', '10500000', '10510000', '1051100', '105111', '10510200', '10520000', '10530000', '10540000', '10550000', '10560000', '14200000', '14210000', '10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','30010000', '30050000', '30060000', '30070000', '30080000', '30090000', '30301000', '30110000', '31100000','10480000','10390000','10370000','10450000','10420000','10470000','10010000','10380000','14200000','20020000','30010000','30050000','10020000','10440000','20260000','10081300','20010000','30070000','20010000','30070000','40010000', '40060000', '40070000', '40080000', '40090000', '40100000', '40110000', '40120000', '40130000')
    AND EST.ESTOQUE > 0
    AND EST.CODEMP IN ('4'))BBB
    GROUP BY
    BBB.CODPROD,
    BBB.NOME_MATRIZ) DDD ON DDD.CODPROD = PRO.CODPROD
    WHERE
    PRO.USOPROD = 'R'
    AND PRO.AD_COD_EX IS NULL
    AND PRO.AD_TIP_ALT = 'M') ZZZ ON ZZZ.CODPROD = PRO.CODPROD

LEFT JOIN (
    /**/
SELECT
    PPP.CODPROD,
    PPP.CUSREP
    FROM
    (SELECT
        MAX(DATA) AS DATA,
        AAA.CODPROD
        FROM
        (SELECT
        ZZZ.CODPROD,
        ZZZ.NOME_MATRIZ,
        ZZZ.CODPRODALT,
        ZZZ.NOME_ALTER,
        CCC.CUSREP,
        CCC.DATA
        FROM
        (SELECT
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_MATRIZ,
            PRO.AD_TIP_ALT,
            PAL.CODPRODALT,
            NOM.DESCRPROD AS NOME_ALTER
            FROM
            TGFPRO PRO
            LEFT JOIN TGFPAL PAL ON PAL.CODPROD = PRO.CODPROD
            LEFT JOIN TGFPRO NOM ON PAL.CODPRODALT = NOM.CODPROD
            WHERE
            PRO.USOPROD = 'R'
            AND PRO.AD_COD_EX IS NULL
            AND PRO.AD_TIP_ALT = 'M'
            UNION ALL
            SELECT
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_MATRIZ,
            PRO.AD_TIP_ALT,
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_ALTER
            FROM
            TGFPRO PRO
            WHERE
            PRO.USOPROD = 'R'
            AND PRO.AD_COD_EX IS NULL
            AND PRO.AD_TIP_ALT = 'M') ZZZ
        LEFT JOIN (SELECT 
            DDD.CODPROD,
            CUS.CUSREP,
            DDD.DATA
            FROM TGFCUS CUS,
            (SELECT 
                MAX (EEE.DTATUAL) AS DATA,
                EEE.CODPROD
                FROM TGFCUS EEE
                GROUP BY
                EEE.CODPROD) DDD
            WHERE
            DDD.CODPROD = CUS.CODPROD
            AND DDD.DATA = CUS.DTATUAL) CCC ON CCC.CODPROD = ZZZ.CODPRODALT
        WHERE ZZZ.CODPRODALT IS NOT NULL) AAA
        GROUP BY
        AAA.CODPROD) DDD
    LEFT JOIN (SELECT
        ZZZ.CODPROD,
        ZZZ.NOME_MATRIZ,
        CCC.CUSREP,
        CCC.DATA
        FROM
        (SELECT
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_MATRIZ,
            PRO.AD_TIP_ALT,
            PAL.CODPRODALT,
            NOM.DESCRPROD AS NOME_ALTER
            FROM
            TGFPRO PRO
            LEFT JOIN TGFPAL PAL ON PAL.CODPROD = PRO.CODPROD
            LEFT JOIN TGFPRO NOM ON PAL.CODPRODALT = NOM.CODPROD
            WHERE
            PRO.USOPROD = 'R'
            AND PRO.AD_COD_EX IS NULL
            AND PRO.AD_TIP_ALT = 'M'
            UNION ALL
            SELECT
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_MATRIZ,
            PRO.AD_TIP_ALT,
            PRO.CODPROD,
            PRO.DESCRPROD AS NOME_ALTER
            FROM
            TGFPRO PRO
            WHERE
            PRO.USOPROD = 'R'
            AND PRO.AD_COD_EX IS NULL
            AND PRO.AD_TIP_ALT = 'M') ZZZ
        LEFT JOIN (SELECT 
            DISTINCT(DDD.CODPROD) AS CODPROD,
            MAX(CUS.CUSREP) AS CUSREP,
            CUS.DTATUAL AS DATA
            FROM 
            (SELECT 
                MAX (EEE.DTATUAL) AS DATA,
                EEE.CODPROD,
                EEE.CODPROD || MAX (EEE.DTATUAL) AS VALID
                FROM TGFCUS EEE
                GROUP BY
                EEE.CODPROD) DDD
            LEFT JOIN TGFCUS CUS ON DDD.VALID = CUS.CODPROD || CUS.DTATUAL
            GROUP BY
            DDD.CODPROD,
            CUS.DTATUAL) CCC ON CCC.CODPROD = ZZZ.CODPRODALT
        WHERE ZZZ.CODPRODALT IS NOT NULL) PPP ON DDD.CODPROD = PPP.CODPROD 
        WHERE PPP.DATA = DDD.DATA
        /**/
        ) PPP ON PPP.CODPROD = PRO.CODPROD
WHERE
PRO.USOPROD = 'R'
AND PRO.AD_COD_EX IS NULL
AND PRO.AD_TIP_ALT = 'M'
